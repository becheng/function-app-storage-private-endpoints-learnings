# Private Endpoints for the Win!: Why a Private Endpoint is superior over a Service Endpoint when accessing Azure Storage 

Got an interesting ask from a customer recently - *How to access to an Azure storage account both privately and publicly at the same time?*  The customer wanted their app running on an Azure app service to have a direct connection over the backbone network to a storage account to upload files generated by the app, i.e., *private access*, while at the same time, allowing end users to download these files over the internet given a SAS uri, i.e., *public access*.  

## Using a Service Endpoint
The customer already well versed with service endpoints from previous implementations, initially implemented a service endpoint.  A service endpoint allows an app service to use a private IP from a integration subnet as an outbound address.  An integration subnet is specified when configuring the app service's Regional VNet Integration.  This change allows the downstream storage account to see the ingress originating from integration subnet.  This enables the storage account to configure a firewall rule to whitelist traffic from the integration subnet.      

## An Unexpected Challenge
While this worked out great to achieve private access to storage, the customer faced an unexpected challenge.  The act of enabling the storage's firewall meant any other access to the account required additional firewall rules, either by IP addresses or Vnet/Subnets, including the IP address of each end user needing access.  In the customer's case, end users could be located any where, including users on their mobile devices. Configuring individual IP addresses per user would not be possible.          

## Private Endpoint for the Win
The solution - **private endpoint with private link**.  Like a service endpoint, a private endpoint has all the goodness of keeping traffic within Azure backbone network by leveraging IP addressing within a VNet.  However, unlike a service endpoint where the app service's outbound address is sourced from the integration subnet which enables the target resource to easily identify that ingress is originating from a specific VNet/subnet, a private endpoint is assigned an IP address from another subnet within the integration VNet.  The private endpoint is then connected to the storage account using the private link service.  Effectively these changes allow the storage account to be injected in the integration VNet, allowing the egress of the app service to reach the storage account via its injected private ip.  This paradigm leads to other private endpoint's key difference - the public ip address can still exist for the target resource, the storage account.  Since the storage's public ip is no longer used by the upstream app service, the storage's firewall is independent of the app service's private access to it.  A customer can choose to configure the firewall at their discretion - to disable all public access, to allow certain public access by IP addresses, or in the case of my customer, not configure any rules so the storage account is public to meet the dynamicity of their end users.     


References:
- https://learn.microsoft.com/en-us/azure/virtual-network/vnet-integration-for-azure-services
